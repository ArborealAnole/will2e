
\documentclass{ltxdoc}
\EnableCrossrefs
\CodelineIndex
\RecordChanges


\def\trialtext{\Huge
$\smash{M_n}$
$\smash{M_n'}$}
\newsavebox\default
\savebox\default{\trialtext}



\def\codeline{\par\noindent\hspace{2\parindent}}
\setlength\parindent{2em}

\usepackage[utf8]{inputenc}
\usepackage[svgnames]{xcolor}
\usepackage{booktabs,calc,enumitem,graphicx,ifthen,refstyle,subfig,varioref,subdepth,url}

\definecolor{niceblue}{rgb}{0.2,0.4,0.8}
\def\theCodelineNo{\textcolor{niceblue}{\sffamily\tiny\arabic{CodelineNo}}}

\newcommand*\pkg[1]{\textsf{#1}}

\newcounter{argument}
\makeatletter
\g@addto@macro\endmacro{\setcounter{argument}{0}}
\makeatother
\newcommand*\darg[1]{%
  \stepcounter{argument}%
  {\ttfamily\char`\#\theargument~:~}#1\par\noindent\ignorespaces}
\newcommand*\doarg[1]{%
  \stepcounter{argument}%
  {\ttfamily\makebox[0pt][r]{[}\char`\#\theargument]:~}#1\par\noindent\ignorespaces}


\begin{document}

\GetFileInfo{subdepth.sty}
\CheckSum{0}
\makeatletter

\title{The \textsf{subdepth} package: unify subscript depths}
\author{Original code by Donald Arseneau\\ Maintained by Will Robertson}
\date{\filedate \qquad \fileversion}

\maketitle

\begin{quote}\small\em
This package arose from the following \texttt{comp.text.tex} post by Donald Arseneau: \url{http://groups.google.com/group/comp.text.tex/msg/f207c7535810d2c1}.
\end{quote}

\section{Introduction}

Consider the standard output of a subscript with and without a superscript above:
\begin{center}
\usebox\default
\end{center}
The second $n$ is lower due to \TeX's default of jiggling the space when there are both superscripts and subscripts attached to a math symbol.

In general this is considered typographically appropriate as the `lower' position in the second example is too low for a plain subscript.
However, in some circumstances this isn't particularly desirable, particularly in fields such as chemistry where a variable subscript position can look inconsistent within a single chemical formula.

This package adjusts \LaTeX's behaviour to unify the position of the subscript in both cases:
\begin{center}
\trialtext
\end{center}
Notice that to compensate for the higher subscript, the superscript position is slightly raised. The |[low-sup]| package option will suppress this change to the height of the superscripts.

\section{Fine tuning}

The original code was originally developed for typesetting symbols in chemistry such as $H_2$ and $H_2^+$, where you don't want the subscript to be moving around. Indeed, \pkg{subdepth} uses this example to measure the lengths it needs to do its adjustments nicely.


\section{Algorithm}

\def\supsym#1{%
  \smash{\color{red}%
    \makebox[0pt][l]{\rule[-0.4pt]{0.7cm}{0.4pt}}
    \rule
      [-\the\fontdimen#1\textfont2]
      {0.4pt}{\the\fontdimen#1\textfont2}}
   i}
\def\subsym#1{%
  \smash{\color{red}%
    \makebox[0pt][l]{\rule[-0.4pt]{0.7cm}{0.4pt}}
    \rule{0.4pt}{\the\fontdimen#1\textfont2}}
   i}

\savebox\@tempboxa{$~$}%
\edef\reset{%
   \fontdimen13\noexpand\textfont2=\the\fontdimen13\textfont2
   \fontdimen14\noexpand\textfont2=\the\fontdimen14\textfont2
   \fontdimen15\noexpand\textfont2=\the\fontdimen15\textfont2
   \fontdimen16\noexpand\textfont2=\the\fontdimen16\textfont2
   \fontdimen17\noexpand\textfont2=\the\fontdimen17\textfont2
 }

\def\a#1{\noindent
{\footnotesize\ttfamily1.5\cmd{\fontdimen#1}:}
\hfill
\reset$\displaystyle\sum A^{\supsym{13}}$\quad
\fontdimen#1\textfont2=1.5\fontdimen#1\textfont2
$\displaystyle A^{\supsym{13}}$\hfill
\reset$\sum A^{\supsym{14}}$\quad
\fontdimen#1\textfont2=1.5\fontdimen#1\textfont2
$A^{\supsym{14}}$\hfill
\reset$\sqrt{A^{\supsym{15}}}$\quad
\fontdimen#1\textfont2=1.5\fontdimen#1\textfont2
$\sqrt{A^{\supsym{15}}}$\hfill
\reset\null\par\bigskip}

\def\b#1{\noindent
{\footnotesize\ttfamily2\cmd{\fontdimen#1}:}\hfill
\reset$A_{\subsym{16}}$\quad
\fontdimen#1\textfont2=2\fontdimen#1\textfont2
$A_{\subsym{16}}$\hfill
\reset$A^B_{\subsym{17}}$\quad
\fontdimen#1\textfont2=2\fontdimen#1\textfont2
$A^B_{\subsym{17}}$\hfill
\reset\null\par\bigskip}


The intricacies of \TeX's behaviour for maths typesetting are well described by Bogus≈Çaw `Jacko' Jackowski in his TUGboat paper `Appendix G illuminated':
\url{https://www.tug.org/members/TUGboat/tb27-1/tb86jackowski.pdf}

Superscript symbols are placed vertically according to fontdimens 13 (display), 14 (text), and~15 (cramped).

\bigskip
\a{13}
\a{14}
\a{15}

For subscripts, fontdimens 16 and 17 are used when and when not a superscript is also present, respectively.

\bigskip
\b{16}
\b{17}

Fontdimens 18 and 19 are used to place the subscript and superscript, respectively, when they are attached to a boxed formula. But we don't care for that special case, because it already looks fine.

Furthermore, if subscripts and superscripts clash then their spacing will be adjusted to compensate.

First of all, the superscript must not extend too low, or it is raised to not exceed this minimum:
\begin{center}
\@for\@ii:={0pt,1pt,2pt,3pt,4pt,5pt,6pt}\do{%
  \scalebox{2}{$A^{\rule[-\@ii]{0.5ex}{0.5ex+\@ii}}$\quad}}
\end{center}
Similarly, the subscript cannot extend too high:
\begin{center}
\@for\@ii:={0pt,1pt,2pt,3pt,4pt,5pt,6pt}\do{%
  \scalebox{2}{$A_{\rule{0.5ex}{0.5ex+\@ii}}$\quad}}
\end{center}
Note that the `too low' position for the superscript and the `too high' for the subscript overlap. There are further restrictions when they clash. When the superscript clashes with the subscript:
\begin{center}
\@for\@ii:={0pt,1pt,2pt,3pt,4pt,5pt,6pt}\do{%
  \scalebox{2}{$A_{\rule{0.5ex}{0.5ex}}^{\rule[-\@ii]{0.5ex}{0.5ex+\@ii}}$\quad}}
\end{center}
And when the subscript clashes when the superscript:
\begin{center}
\@for\@ii:={0pt,1pt,2pt,3pt,4pt,5pt,6pt}\do{%
  \scalebox{2}{$A^{\rule{0.5ex}{0.5ex}}_{\rule{0.5ex}{0.5ex+\@ii}}$\quad}}
\end{center}
And when they both grow:
\begin{center}
\@for\@ii:={0pt,1pt,2pt,3pt,4pt,5pt,6pt}\do{%
  \scalebox{2}{$A^{\rule[-\@ii]{0.5ex}{0.5ex+\@ii}}_{\rule{0.5ex}{0.5ex+\@ii}}$\quad}}
\end{center}

The parameter that mainly controls the details of all these adjustments is the x-height of the font, fontdimen 5.


\part{\textsf{\jobname} implementation}

\DocInput{subdepth-code.dtx}

\end{document}
